<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç«¯GPUä¼˜åŒ–æ¸²æŸ“å¼•æ“ - Splineé£æ ¼</title>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ä¸»å®¹å™¨ */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333333;
            overflow: hidden;
        }

        /* ä¸»å¸ƒå±€å®¹å™¨ */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #ffffff;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* å·¦ä¾§å¯¼èˆª */
        .left-nav {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        /* Logo */
        .logo {
            font-size: 20px;
            font-weight: 600;
            color: #1976d2;
        }

        /* ä¸»å¯¼èˆªèœå• */
        .nav-menu {
            display: flex;
            gap: 16px;
            list-style: none;
        }

        .nav-menu li {
            position: relative;
        }

        .nav-menu a {
            text-decoration: none;
            color: #333333;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .nav-menu a:hover {
            background-color: #f0f7ff;
            color: #1976d2;
        }

        /* å³ä¾§å¯¼èˆª */
        .right-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* æœç´¢æ¡† */
        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 8px 32px 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            background-color: #f5f5f5;
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #1976d2;
            background-color: #ffffff;
        }

        /* ç”¨æˆ·ä¿¡æ¯ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f5f5f5;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-info:hover {
            background-color: #e0e0e0;
        }

        /* ä¸»å†…å®¹åŒº */
        .content-area {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å·¦ä¾§é¢æ¿ */
        .left-panel {
            width: 250px;
            background-color: #ffffff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* å·¦ä¾§é¢æ¿æ ‡ç­¾é¡µ */
        .panel-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background-color: transparent;
            font-size: 14px;
            font-weight: 500;
            color: #666666;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
            background-color: #f0f7ff;
        }

        .tab-btn:hover:not(.active) {
            background-color: #f5f5f5;
        }

        /* é¢æ¿å†…å®¹ */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* åœºæ™¯æ ‘ */
        .scene-tree {
            list-style: none;
        }

        .scene-tree-item {
            margin: 4px 0;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scene-tree-item:hover {
            background-color: #f0f7ff;
        }

        .scene-tree-item.active {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        /* å¯¹è±¡åº“ */
        .object-library {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .object-card {
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .object-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: #1976d2;
        }

        .object-card-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .object-card-title {
            font-size: 12px;
            font-weight: 500;
        }

        /* ä¸­å¤®è§†å›¾åŒº */
        .viewport-area {
            flex: 1;
            background-color: #fafafa;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* è§†å›¾æ§åˆ¶å·¥å…·æ  */
        .view-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 16px;
        }

        .control-btn {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background-color: #f5f5f5;
        }

        .control-btn.active {
            background-color: #1976d2;
            color: #ffffff;
            border-color: #1976d2;
        }

        /* 3Dè§†å›¾ */
        .viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #canvas {
            width: 100%;
            height: 100%;
            background-color: #fafafa;
            cursor: grab;
        }

        #canvas:active {
            cursor: grabbing;
        }

        /* å³ä¾§å±æ€§é¢æ¿ */
        .right-panel {
            width: 300px;
            background-color: #ffffff;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* å±æ€§é¢æ¿æ ‡ç­¾é¡µ */
        .property-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
        }

        /* å±æ€§ç»„ */
        .property-group {
            margin-bottom: 16px;
        }

        .property-group-title {
            font-size: 13px;
            font-weight: 600;
            color: #666666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* å±æ€§é¡¹ */
        .property-item {
            margin-bottom: 12px;
        }

        .property-label {
            font-size: 12px;
            font-weight: 500;
            color: #666666;
            margin-bottom: 4px;
            display: block;
        }

        .property-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .property-input:focus {
            outline: none;
            border-color: #1976d2;
        }

        /* é¢œè‰²é€‰æ‹©å™¨ */
        .color-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .color-preview {
            width: 24px;
            height: 24px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
        }

        /* æ»‘å—è¾“å…¥ */
        .slider-input {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .slider-input input[type="range"] {
            flex: 1;
        }

        .slider-input input[type="number"] {
            width: 60px;
        }

        /* åº•éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 32px;
            background-color: #ffffff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 24px;
            font-size: 12px;
            color: #666666;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* æ¸²æŸ“çŠ¶æ€ */
        .render-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4caf50;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .left-panel {
                width: 200px;
            }
            
            .right-panel {
                width: 250px;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* æ¶ˆæ¯æç¤º */
        .message-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333333;
            color: #ffffff;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1000;
        }

        .message-toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="top-nav">
            <div class="left-nav">
                <div class="logo">ä½ç«¯GPUä¼˜åŒ–æ¸²æŸ“å¼•æ“</div>
                <ul class="nav-menu">
                    <li><a href="#">æ–‡ä»¶</a></li>
                    <li><a href="#">ç¼–è¾‘</a></li>
                    <li><a href="#">è§†å›¾</a></li>
                    <li><a href="#">å¯¹è±¡</a></li>
                    <li><a href="#">æ¸²æŸ“</a></li>
                    <li><a href="#">çª—å£</a></li>
                    <li><a href="#">å¸®åŠ©</a></li>
                </ul>
            </div>
            <div class="right-nav">
                <div class="search-box">
                    <input type="text" placeholder="æœç´¢...">
                </div>
                <div class="user-info">
                    <span>ç”¨æˆ·</span>
                </div>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="content-area">
            <!-- å·¦ä¾§é¢æ¿ -->
            <aside class="left-panel">
                <!-- å·¦ä¾§é¢æ¿æ ‡ç­¾é¡µ -->
                <div class="panel-tabs">
                    <button class="tab-btn active" data-tab="scene">åœºæ™¯æ ‘</button>
                    <button class="tab-btn" data-tab="objects">å¯¹è±¡åº“</button>
                </div>

                <!-- åœºæ™¯æ ‘å†…å®¹ -->
                <div id="scene" class="panel-content">
                    <ul class="scene-tree">
                        <li class="scene-tree-item active">
                            <span>ğŸŒ</span>
                            <span>åœºæ™¯</span>
                        </li>
                        <li class="scene-tree-item" style="margin-left: 20px;">
                            <span>ğŸ“·</span>
                            <span>ç›¸æœº</span>
                        </li>
                        <li class="scene-tree-item" style="margin-left: 20px;">
                            <span>ğŸ’¡</span>
                            <span>æ–¹å‘å…‰</span>
                        </li>
                        <li class="scene-tree-item" style="margin-left: 20px;">
                            <span>ğŸ“¦</span>
                            <span>ç«‹æ–¹ä½“</span>
                        </li>
                        <li class="scene-tree-item" style="margin-left: 20px;">
                            <span>ğŸ”µ</span>
                            <span>çƒä½“</span>
                        </li>
                        <li class="scene-tree-item" style="margin-left: 20px;">
                            <span>ğŸ“</span>
                            <span>åœ†æŸ±ä½“</span>
                        </li>
                    </ul>
                </div>

                <!-- å¯¹è±¡åº“å†…å®¹ -->
                <div id="objects" class="panel-content" style="display: none;">
                    <h3 style="margin-bottom: 16px; font-size: 14px; font-weight: 600;">åŸºç¡€å‡ ä½•ä½“</h3>
                    <div class="object-library">
                        <div class="object-card" data-object="cube">
                            <div class="object-card-icon">ğŸ“¦</div>
                            <div class="object-card-title">ç«‹æ–¹ä½“</div>
                        </div>
                        <div class="object-card" data-object="sphere">
                            <div class="object-card-icon">ğŸ”µ</div>
                            <div class="object-card-title">çƒä½“</div>
                        </div>
                        <div class="object-card" data-object="cylinder">
                            <div class="object-card-icon">ğŸ“</div>
                            <div class="object-card-title">åœ†æŸ±ä½“</div>
                        </div>
                        <div class="object-card" data-object="plane">
                            <div class="object-card-icon">ğŸ“„</div>
                            <div class="object-card-title">å¹³é¢</div>
                        </div>
                        <div class="object-card" data-object="cone">
                            <div class="object-card-icon">ğŸ”º</div>
                            <div class="object-card-title">åœ†é”¥ä½“</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- ä¸­å¤®è§†å›¾åŒº -->
            <section class="viewport-area">
                <!-- è§†å›¾æ§åˆ¶å·¥å…·æ  -->
                <div class="view-controls">
                    <button class="control-btn active" data-tool="select">é€‰æ‹©</button>
                    <button class="control-btn" data-tool="move">ç§»åŠ¨</button>
                    <button class="control-btn" data-tool="rotate">æ—‹è½¬</button>
                    <button class="control-btn" data-tool="scale">ç¼©æ”¾</button>
                    <div style="flex: 1;"></div>
                    <button class="control-btn" data-view="perspective">é€è§†</button>
                    <button class="control-btn" data-view="orthographic">æ­£äº¤</button>
                    <button class="control-btn" data-view="top">é¡¶è§†å›¾</button>
                    <button class="control-btn" data-view="front">å‰è§†å›¾</button>
                    <button class="control-btn" data-view="right">å³è§†å›¾</button>
                </div>

                <!-- 3Dè§†å›¾ -->
                <div class="viewport">
                    <canvas id="canvas"></canvas>
                    <div class="loading-spinner"></div>
                </div>
            </section>

            <!-- å³ä¾§å±æ€§é¢æ¿ -->
            <aside class="right-panel">
                <!-- å±æ€§é¢æ¿æ ‡ç­¾é¡µ -->
                <div class="property-tabs">
                    <button class="tab-btn active" data-tab="properties">å±æ€§</button>
                    <button class="tab-btn" data-tab="render">æ¸²æŸ“è®¾ç½®</button>
                </div>

                <!-- å±æ€§å†…å®¹ -->
                <div id="properties" class="panel-content">
                    <!-- å˜æ¢å±æ€§ -->
                    <div class="property-group">
                        <div class="property-group-title">å˜æ¢</div>
                        
                        <!-- ä½ç½® -->
                        <div class="property-item">
                            <label class="property-label">ä½ç½®</label>
                            <div style="display: flex; gap: 8px;">
                                <div style="flex: 1;">
                                    <input type="number" class="property-input" placeholder="X" value="0">
                                </div>
                                <div style="flex: 1;">
                                    <input type="number" class="property-input" placeholder="Y" value="0">
                                </div>
                                <div style="flex: 1;">
                                    <input type="number" class="property-input" placeholder="Z" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- æ—‹è½¬ -->
                        <div class="property-item">
                            <label class="property-label">æ—‹è½¬</label>
                            <div style="display: flex; gap: 8px;">
                                <div style="flex: 1;">
                                    <input type="number" class="property-input" placeholder="X" value="0">
                                </div>
                                <div style="flex: 1;">
                                    <input type="number" class="property-input" placeholder="Y" value="0">
                                </div>
                                <div style="flex: 1;">
                                    <input type="number" class="property-input" placeholder="Z" value="0">
                                </div>
                            </div>
                        </div>

                        <!-- ç¼©æ”¾ -->
                        <div class="property-item">
                            <label class="property-label">ç¼©æ”¾</label>
                            <div style="display: flex; gap: 8px;">
                                <div style="flex: 1;">
                                    <input type="number" class="property-input" placeholder="X" value="1">
                                </div>
                                <div style="flex: 1;">
                                    <input type="number" class="property-input" placeholder="Y" value="1">
                                </div>
                                <div style="flex: 1;">
                                    <input type="number" class="property-input" placeholder="Z" value="1">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æè´¨å±æ€§ -->
                    <div class="property-group">
                        <div class="property-group-title">æè´¨</div>
                        
                        <!-- é¢œè‰² -->
                        <div class="property-item">
                            <label class="property-label">é¢œè‰²</label>
                            <div class="color-input">
                                <div class="color-preview" style="background-color: #ffffff;"></div>
                                <input type="color" class="property-input" value="#ffffff" style="flex: 1;">
                            </div>
                        </div>

                        <!-- é‡‘å±åº¦ -->
                        <div class="property-item">
                            <label class="property-label">é‡‘å±åº¦</label>
                            <div class="slider-input">
                                <input type="range" min="0" max="1" step="0.1" value="0">
                                <input type="number" class="property-input" min="0" max="1" step="0.1" value="0">
                            </div>
                        </div>

                        <!-- ç²—ç³™åº¦ -->
                        <div class="property-item">
                            <label class="property-label">ç²—ç³™åº¦</label>
                            <div class="slider-input">
                                <input type="range" min="0" max="1" step="0.1" value="0.5">
                                <input type="number" class="property-input" min="0" max="1" step="0.1" value="0.5">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¸²æŸ“è®¾ç½®å†…å®¹ -->
                <div id="render" class="panel-content" style="display: none;">
                    <div class="property-group">
                        <div class="property-group-title">æ¸²æŸ“è®¾ç½®</div>
                        
                        <!-- æ¸²æŸ“è´¨é‡ -->
                        <div class="property-item">
                            <label class="property-label">æ¸²æŸ“è´¨é‡</label>
                            <select class="property-input">
                                <option value="low">ä½</option>
                                <option value="medium" selected>ä¸­</option>
                                <option value="high">é«˜</option>
                            </select>
                        </div>

                        <!-- æŠ—é”¯é½¿ -->
                        <div class="property-item">
                            <label class="property-label">æŠ—é”¯é½¿</label>
                            <select class="property-input">
                                <option value="none">æ— </option>
                                <option value="fxaa">FXAA</option>
                                <option value="msaa">MSAA</option>
                            </select>
                        </div>

                        <!-- é˜´å½±è´¨é‡ -->
                        <div class="property-item">
                            <label class="property-label">é˜´å½±è´¨é‡</label>
                            <select class="property-input">
                                <option value="low">ä½</option>
                                <option value="medium" selected>ä¸­</option>
                                <option value="high">é«˜</option>
                            </select>
                        </div>
                    </div>
                </div>
            </aside>
        </main>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <footer class="status-bar">
            <div class="status-item">
                <div class="status-indicator"></div>
                <span>æ¸²æŸ“ä¸­</span>
            </div>
            <div class="status-item">
                <span>FPS: <span id="fps">0</span></span>
            </div>
            <div class="status-item">
                <span>æ¸²æŸ“æ—¶é—´: <span id="render-time">0</span>ms</span>
            </div>
            <div class="status-item">
                <span>ç»˜åˆ¶è°ƒç”¨: <span id="draw-calls">0</span></span>
            </div>
            <div class="status-item">
                <span>ä¸‰è§’å½¢: <span id="triangles">0</span></span>
            </div>
            <div class="status-item">
                <span>åœºæ™¯å¯¹è±¡: <span id="objects-count">0</span></span>
            </div>
        </footer>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div class="message-toast" id="message-toast"></div>

    <script>
        // WebSocketè¿æ¥ç®¡ç†
        class WebSocketManager {
            constructor() {
                this.socket = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
            }

            connect() {
                // è·å–å½“å‰é¡µé¢çš„ä¸»æœºå’Œç«¯å£
                const host = window.location.hostname;
                const port = window.location.port;
                
                // å°è¯•å¤šä¸ªWebSocketç«¯å£ï¼Œå› ä¸ºé»˜è®¤ç«¯å£å¯èƒ½è¢«å ç”¨
                const wsPorts = [parseInt(port) + 1, parseInt(port) + 2, parseInt(port) + 3];
                let socket = null;
                let connected = false;
                
                for (const wsPort of wsPorts) {
                    try {
                        socket = new WebSocket(`ws://${host}:${wsPort}`);
                        
                        // ç«‹å³è®¾ç½®onopenäº‹ä»¶å¤„ç†ç¨‹åºï¼Œæ£€æŸ¥è¿æ¥æ˜¯å¦æˆåŠŸ
                        socket.onopen = () => {
                            console.log(`WebSocketè¿æ¥å·²å»ºç«‹åˆ°ç«¯å£ ${wsPort}`);
                            this.isConnected = true;
                            this.reconnectAttempts = 0;
                            this.hideLoading();
                            this.showMessage('WebSocketè¿æ¥å·²å»ºç«‹');
                        };

                        this.socket = socket;
                        connected = true;
                        break;
                    } catch (error) {
                        console.log(`WebSocketè¿æ¥åˆ°ç«¯å£ ${wsPort} å¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªç«¯å£...`);
                    }
                }
                
                if (!connected) {
                    console.error('æ— æ³•è¿æ¥åˆ°ä»»ä½•WebSocketç«¯å£');
                    this.showMessage('æ— æ³•è¿æ¥åˆ°WebSocketæœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€', 'error');
                    return;
                }
                
                // è®¾ç½®å…¶ä»–WebSocketäº‹ä»¶å¤„ç†ç¨‹åº
                this.socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                };

                this.socket.onclose = () => {
                    console.log('WebSocketè¿æ¥å·²å…³é—­');
                    this.isConnected = false;
                    this.showLoading();
                    this.attemptReconnect();
                };

                this.socket.onerror = (error) => {
                    console.error('WebSocketé”™è¯¯:', error);
                    this.showMessage('WebSocketè¿æ¥é”™è¯¯', 'error');
                };
            }

            handleMessage(data) {
                switch (data.type) {
                    case 'welcome':
                        console.log('æ¬¢è¿æ¶ˆæ¯:', data.data);
                        break;
                    case 'initial_state':
                        this.handleInitialState(data.data);
                        break;
                    case 'update_status':
                        this.handleStatusUpdate(data.data);
                        break;
                    case 'render_frame':
                        this.handleRenderFrame(data.data);
                        break;
                    case 'heartbeat':
                        this.sendHeartbeat();
                        break;
                    case 'error':
                        console.error('æœåŠ¡å™¨é”™è¯¯:', data.data);
                        this.showMessage(`æœåŠ¡å™¨é”™è¯¯: ${data.data}`, 'error');
                        break;
                    case 'response':
                        console.log('æœåŠ¡å™¨å“åº”:', data.data);
                        this.showMessage(data.data);
                        break;
                    default:
                        console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
                }
            }

            handleInitialState(state) {
                console.log('åˆå§‹çŠ¶æ€:', state);
                // æ›´æ–°åœºæ™¯å¯¹è±¡æ•°é‡
                document.getElementById('objects-count').textContent = state.scene_info.objects_count;
                // æ›´æ–°å¼•æ“çŠ¶æ€
                const engineStatus = state.engine_status === 'running' ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                document.querySelector('.status-item span:nth-child(2)').textContent = engineStatus;
            }

            handleStatusUpdate(status) {
                // æ›´æ–°FPS
                document.getElementById('fps').textContent = status.fps;
                // æ›´æ–°æ¸²æŸ“æ—¶é—´
                document.getElementById('render-time').textContent = status.render_time_ms;
                // æ›´æ–°ç»˜åˆ¶è°ƒç”¨
                document.getElementById('draw-calls').textContent = status.draw_calls;
                // æ›´æ–°ä¸‰è§’å½¢æ•°é‡
                document.getElementById('triangles').textContent = status.triangles;
                // æ›´æ–°åœºæ™¯å¯¹è±¡æ•°é‡
                document.getElementById('objects-count').textContent = status.scene_objects;
            }

            handleRenderFrame(frameData) {
                // å¤„ç†æ¸²æŸ“å¸§æ•°æ®ï¼Œæ›´æ–°Canvas
                console.log('æ”¶åˆ°æ¸²æŸ“å¸§æ•°æ®');
                
                try {
                    // åˆ›å»ºå›¾åƒå¯¹è±¡
                    const img = new Image();
                    img.onload = () => {
                        // ç»˜åˆ¶å›¾åƒåˆ°Canvas
                        const canvas = document.getElementById('canvas');
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = frameData;
                } catch (error) {
                    console.error('å¤„ç†æ¸²æŸ“å¸§æ•°æ®å¤±è´¥:', error);
                }
            }

            sendHeartbeat() {
                if (this.isConnected) {
                    this.send({ type: 'heartbeat' });
                }
            }

            send(message) {
                if (this.isConnected) {
                    this.socket.send(JSON.stringify(message));
                } else {
                    console.error('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
                    this.showMessage('WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
                }
            }

            attemptReconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`å°è¯•é‡æ–°è¿æ¥... (${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
                    setTimeout(() => {
                        this.connect();
                    }, this.reconnectDelay * this.reconnectAttempts);
                } else {
                    console.error('å·²è¾¾åˆ°æœ€å¤§é‡æ–°è¿æ¥æ¬¡æ•°');
                    this.showMessage('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
                }
            }

            close() {
                if (this.socket) {
                    this.socket.close();
                }
            }

            showLoading() {
                const spinner = document.querySelector('.loading-spinner');
                if (spinner) {
                    spinner.style.display = 'block';
                }
            }

            hideLoading() {
                const spinner = document.querySelector('.loading-spinner');
                if (spinner) {
                    spinner.style.display = 'none';
                }
            }

            showMessage(message, type = 'info') {
                const toast = document.getElementById('message-toast');
                toast.textContent = message;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }

        // åˆå§‹åŒ–WebSocketè¿æ¥
        const wsManager = new WebSocketManager();
        wsManager.connect();

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            // åˆå§‹åŒ–Canvas
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');

            // 3Dè§†å›¾æ§åˆ¶å™¨
            class ViewportController {
                constructor(canvas, wsManager) {
                    this.canvas = canvas;
                    this.wsManager = wsManager;
                    this.isMouseDown = false;
                    this.lastMouseX = 0;
                    this.lastMouseY = 0;
                    this.isMiddleMouseDown = false;
                    this.isRightMouseDown = false;
                    this.setupEventListeners();
                }

                setupEventListeners() {
                    // é¼ æ ‡äº‹ä»¶
                    this.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e));
                    this.canvas.addEventListener('mousemove', (e) => this.onMouseMove(e));
                    this.canvas.addEventListener('mouseup', (e) => this.onMouseUp(e));
                    this.canvas.addEventListener('wheel', (e) => this.onWheel(e));
                    
                    // é”®ç›˜äº‹ä»¶
                    document.addEventListener('keydown', (e) => this.onKeyDown(e));
                }

                onMouseDown(e) {
                    this.isMouseDown = true;
                    this.lastMouseX = e.clientX;
                    this.lastMouseY = e.clientY;
                    
                    if (e.button === 1) { // ä¸­é”®
                        this.isMiddleMouseDown = true;
                        e.preventDefault();
                    } else if (e.button === 2) { // å³é”®
                        this.isRightMouseDown = true;
                        e.preventDefault();
                    }
                }

                onMouseMove(e) {
                    if (!this.isMouseDown) return;
                    
                    const deltaX = e.clientX - this.lastMouseX;
                    const deltaY = e.clientY - this.lastMouseY;
                    
                    if (this.isRightMouseDown) {
                        // è½¨é“æ—‹è½¬
                        this.wsManager.send({
                            type: 'camera_orbit',
                            data: { deltaX, deltaY }
                        });
                    } else if (this.isMiddleMouseDown) {
                        // å¹³ç§»
                        this.wsManager.send({
                            type: 'camera_pan',
                            data: { deltaX, deltaY }
                        });
                    }
                    
                    this.lastMouseX = e.clientX;
                    this.lastMouseY = e.clientY;
                }

                onMouseUp(e) {
                    this.isMouseDown = false;
                    if (e.button === 1) {
                        this.isMiddleMouseDown = false;
                    } else if (e.button === 2) {
                        this.isRightMouseDown = false;
                    }
                }

                onWheel(e) {
                    e.preventDefault();
                    // ç¼©æ”¾
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    this.wsManager.send({
                        type: 'camera_zoom',
                        data: { delta }
                    });
                }

                onKeyDown(e) {
                    // WASDç§»åŠ¨ç›¸æœº
                    const directionMap = {
                        'w': 'forward',
                        's': 'backward',
                        'a': 'left',
                        'd': 'right',
                        'q': 'up',
                        'e': 'down'
                    };
                    
                    const direction = directionMap[e.key.toLowerCase()];
                    if (direction) {
                        e.preventDefault();
                        this.wsManager.send({
                            type: 'camera_move',
                            data: { direction }
                        });
                    }
                }
            }

            // è°ƒæ•´Canvaså¤§å°
            function resizeCanvas() {
                const viewport = document.querySelector('.viewport');
                canvas.width = viewport.clientWidth;
                canvas.height = viewport.clientHeight;
            }

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // ç¦æ­¢Canvaså³é”®èœå•
            canvas.addEventListener('contextmenu', (e) => e.preventDefault());

            // ç»˜åˆ¶ç®€å•çš„åŠ è½½ç”»é¢
            function drawLoadingScreen() {
                ctx.fillStyle = '#fafafa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // ç»˜åˆ¶ç®€å•çš„3Dåæ ‡è½´
                ctx.lineWidth = 2;
                
                // Xè½´ - çº¢è‰²
                ctx.strokeStyle = '#ff0000';
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 - 50, canvas.height / 2);
                ctx.lineTo(canvas.width / 2 + 50, canvas.height / 2);
                ctx.stroke();
                
                // Yè½´ - ç»¿è‰²
                ctx.strokeStyle = '#00ff00';
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2, canvas.height / 2 - 50);
                ctx.lineTo(canvas.width / 2, canvas.height / 2 + 50);
                ctx.stroke();
                
                // Zè½´ - è“è‰²
                ctx.strokeStyle = '#0000ff';
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 - 35, canvas.height / 2 - 35);
                ctx.lineTo(canvas.width / 2 + 35, canvas.height / 2 + 35);
                ctx.stroke();

                // ç»˜åˆ¶ç®€å•çš„ç«‹æ–¹ä½“
                ctx.strokeStyle = '#333333';
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 - 20, canvas.height / 2 - 20);
                ctx.lineTo(canvas.width / 2 + 20, canvas.height / 2 - 20);
                ctx.lineTo(canvas.width / 2 + 20, canvas.height / 2 + 20);
                ctx.lineTo(canvas.width / 2 - 20, canvas.height / 2 + 20);
                ctx.closePath();
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 - 10, canvas.height / 2 - 30);
                ctx.lineTo(canvas.width / 2 + 30, canvas.height / 2 - 30);
                ctx.lineTo(canvas.width / 2 + 30, canvas.height / 2 + 10);
                ctx.lineTo(canvas.width / 2 - 10, canvas.height / 2 + 10);
                ctx.closePath();
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 - 20, canvas.height / 2 - 20);
                ctx.lineTo(canvas.width / 2 - 10, canvas.height / 2 - 30);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 + 20, canvas.height / 2 - 20);
                ctx.lineTo(canvas.width / 2 + 30, canvas.height / 2 - 30);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 + 20, canvas.height / 2 + 20);
                ctx.lineTo(canvas.width / 2 + 30, canvas.height / 2 + 10);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(canvas.width / 2 - 20, canvas.height / 2 + 20);
                ctx.lineTo(canvas.width / 2 - 10, canvas.height / 2 + 10);
                ctx.stroke();

                // ç»˜åˆ¶3Dè§†å›¾æç¤ºæ–‡å­—
                ctx.fillStyle = '#666666';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('ä½ç«¯GPUä¼˜åŒ–æ¸²æŸ“å¼•æ“', canvas.width / 2, canvas.height / 2 + 80);
                ctx.fillText('æ­£åœ¨ç­‰å¾…æ¸²æŸ“æ•°æ®...', canvas.width / 2, canvas.height / 2 + 100);
                ctx.fillText('å³é”®æ‹–åŠ¨: æ—‹è½¬è§†è§’ | ä¸­é”®æ‹–åŠ¨: å¹³ç§» | æ»šè½®: ç¼©æ”¾ | WASD: ç§»åŠ¨ç›¸æœº', canvas.width / 2, canvas.height / 2 + 120);
            }

            drawLoadingScreen();
            
            // åˆå§‹åŒ–3Dè§†å›¾æ§åˆ¶å™¨
            const viewportController = new ViewportController(canvas, wsManager);

            // åˆå§‹åŒ–æ ‡ç­¾é¡µåˆ‡æ¢
            initializeTabs();
            
            // åˆå§‹åŒ–è§†å›¾æ§åˆ¶
            initializeViewControls();
            
            // åˆå§‹åŒ–å¯¹è±¡åº“
            initializeObjectLibrary();
            
            // åˆå§‹åŒ–åœºæ™¯æ ‘
            initializeSceneTree();
        });

        // åˆå§‹åŒ–æ ‡ç­¾é¡µåˆ‡æ¢
        function initializeTabs() {
            // å·¦ä¾§é¢æ¿æ ‡ç­¾é¡µ
            const leftTabBtns = document.querySelectorAll('.left-panel .tab-btn');
            leftTabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    leftTabBtns.forEach(b => b.classList.remove('active'));
                    // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
                    btn.classList.add('active');
                    
                    // éšè—æ‰€æœ‰é¢æ¿å†…å®¹
                    const tabContents = document.querySelectorAll('.left-panel .panel-content');
                    tabContents.forEach(content => content.style.display = 'none');
                    
                    // æ˜¾ç¤ºå½“å‰é¢æ¿å†…å®¹
                    const tabId = btn.dataset.tab;
                    document.getElementById(tabId).style.display = 'block';
                });
            });

            // å³ä¾§é¢æ¿æ ‡ç­¾é¡µ
            const rightTabBtns = document.querySelectorAll('.right-panel .tab-btn');
            rightTabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    rightTabBtns.forEach(b => b.classList.remove('active'));
                    // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
                    btn.classList.add('active');
                    
                    // éšè—æ‰€æœ‰é¢æ¿å†…å®¹
                    const tabContents = document.querySelectorAll('.right-panel .panel-content');
                    tabContents.forEach(content => content.style.display = 'none');
                    
                    // æ˜¾ç¤ºå½“å‰é¢æ¿å†…å®¹
                    const tabId = btn.dataset.tab;
                    document.getElementById(tabId).style.display = 'block';
                });
            });
        }

        // åˆå§‹åŒ–è§†å›¾æ§åˆ¶
        function initializeViewControls() {
            const controlBtns = document.querySelectorAll('.control-btn');
            controlBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // å¦‚æœæ˜¯å·¥å…·æŒ‰é’®ï¼Œç§»é™¤å…¶ä»–å·¥å…·æŒ‰é’®çš„æ´»åŠ¨çŠ¶æ€
                    if (btn.dataset.tool) {
                        const toolBtns = document.querySelectorAll('.control-btn[data-tool]');
                        toolBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                    
                    // å‘é€æ§åˆ¶å‘½ä»¤
                    if (btn.dataset.tool) {
                        wsManager.send({ type: `tool_${btn.dataset.tool}` });
                    } else if (btn.dataset.view) {
                        wsManager.send({ type: `view_${btn.dataset.view}` });
                    }
                });
            });
        }

        // åˆå§‹åŒ–å¯¹è±¡åº“
        function initializeObjectLibrary() {
            const objectCards = document.querySelectorAll('.object-card');
            objectCards.forEach(card => {
                card.addEventListener('click', () => {
                    const objectType = card.dataset.object;
                    console.log(`åˆ›å»º${objectType}`);
                    // å‘é€åˆ›å»ºå¯¹è±¡å‘½ä»¤
                    wsManager.send({ type: `create_${objectType}` });
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    wsManager.showMessage(`${objectType}å·²åˆ›å»º`);
                });
            });
        }

        // åˆå§‹åŒ–åœºæ™¯æ ‘
        function initializeSceneTree() {
            const sceneTreeItems = document.querySelectorAll('.scene-tree-item');
            sceneTreeItems.forEach(item => {
                item.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    sceneTreeItems.forEach(i => i.classList.remove('active'));
                    // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
                    item.classList.add('active');
                    // å‘é€é€‰æ‹©èŠ‚ç‚¹å‘½ä»¤
                    const nodeName = item.querySelector('span:nth-child(2)').textContent;
                    wsManager.send({ type: 'select_node', data: nodeName });
                });
            });
        }

        // çª—å£å…³é—­æ—¶å…³é—­WebSocketè¿æ¥
        window.addEventListener('beforeunload', () => {
            wsManager.close();
        });
    </script>
</body>
</html>