<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½ç«¯GPUä¼˜åŒ–æ¸²æŸ“å¼•æ“ - Splineé£æ ¼</title>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ä¸»å®¹å™¨ */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f5f5;
            color: #333333;
            overflow: hidden;
        }

        /* ä¸»å¸ƒå±€å®¹å™¨ */
        .main-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #ffffff;
            padding: 12px 20px;
            border-bottom: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* å·¦ä¾§å¯¼èˆª */
        .left-nav {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        /* Logo */
        .logo {
            font-size: 20px;
            font-weight: 600;
            color: #1976d2;
        }

        /* ä¸»å¯¼èˆªèœå• */
        .nav-menu {
            display: flex;
            gap: 16px;
            list-style: none;
        }

        .nav-menu li {
            position: relative;
        }

        .nav-menu a {
            text-decoration: none;
            color: #333333;
            font-size: 14px;
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .nav-menu a:hover {
            background-color: #f0f7ff;
            color: #1976d2;
        }

        /* å³ä¾§å¯¼èˆª */
        .right-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* æœç´¢æ¡† */
        .search-box {
            position: relative;
        }

        .search-box input {
            padding: 8px 32px 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 14px;
            background-color: #f5f5f5;
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #1976d2;
            background-color: #ffffff;
        }

        /* ç”¨æˆ·ä¿¡æ¯ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #f5f5f5;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-info:hover {
            background-color: #e0e0e0;
        }

        /* ä¸»å†…å®¹åŒº */
        .content-area {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* å·¦ä¾§é¢æ¿ */
        .left-panel {
            width: 250px;
            background-color: #ffffff;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* å·¦ä¾§é¢æ¿æ ‡ç­¾é¡µ */
        .panel-tabs {
            display: flex;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background-color: transparent;
            font-size: 14px;
            font-weight: 500;
            color: #666666;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
            background-color: #f0f7ff;
        }

        .tab-btn:hover:not(.active) {
            background-color: #f5f5f5;
        }

        /* é¢æ¿å†…å®¹ */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* åœºæ™¯æ ‘ */
        .scene-tree {
            list-style: none;
        }

        .scene-tree-item {
            margin: 4px 0;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .scene-tree-item:hover {
            background-color: #f0f7ff;
        }

        .scene-tree-item.active {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        /* å¯¹è±¡åº“ */
        .object-library {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .object-card {
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .object-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: #1976d2;
        }

        .object-card-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .object-card-title {
            font-size: 12px;
            font-weight: 500;
        }

        /* ä¸­å¤®è§†å›¾åŒº */
        .viewport-area {
            flex: 1;
            background-color: #fafafa;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* è§†å›¾æ§åˆ¶å·¥å…·æ  */
        .view-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 16px;
        }

        .control-btn {
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            background-color: #ffffff;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background-color: #f5f5f5;
        }

        .control-btn.active {
            background-color: #1976d2;
            color: #ffffff;
            border-color: #1976d2;
        }

        /* 3Dè§†å›¾ */
        .viewport {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #1a1a1a;
        }

        /* æ¸²æŸ“ç”»å¸ƒ */
        #renderCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #renderCanvas:active {
            cursor: grabbing;
        }

        /* å³ä¾§å±æ€§é¢æ¿ */
        .right-panel {
            width: 300px;
            background-color: #ffffff;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* å±æ€§é¢æ¿æ ‡é¢˜ */
        .panel-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
            font-weight: 600;
            background-color: #f5f5f5;
        }

        /* å±æ€§é¡¹ */
        .property-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .property-label {
            font-size: 12px;
            color: #666666;
            margin-bottom: 6px;
        }

        .property-value {
            font-size: 14px;
            font-weight: 500;
        }

        /* æ•°å€¼è¾“å…¥æ¡† */
        .property-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 14px;
        }

        /* åº•éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 24px;
            background-color: #f5f5f5;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-size: 12px;
            color: #666666;
        }

        .status-item {
            margin-right: 16px;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 16px;
            color: #666666;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <header class="top-nav">
            <div class="left-nav">
                <div class="logo">Engine UI</div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="#">æ–‡ä»¶</a></li>
                        <li><a href="#">ç¼–è¾‘</a></li>
                        <li><a href="#">è§†å›¾</a></li>
                        <li><a href="#">å¸®åŠ©</a></li>
                    </ul>
                </nav>
            </div>
            <div class="right-nav">
                <div class="search-box">
                    <input type="text" placeholder="æœç´¢...">
                </div>
                <div class="user-info">
                    <span>ç”¨æˆ·</span>
                </div>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="content-area">
            <!-- å·¦ä¾§é¢æ¿ -->
            <aside class="left-panel">
                <div class="panel-tabs">
                    <button class="tab-btn active" data-tab="scene">åœºæ™¯</button>
                    <button class="tab-btn" data-tab="objects">å¯¹è±¡åº“</button>
                </div>
                <div class="panel-content">
                    <!-- åœºæ™¯æ ‘ -->
                    <div id="sceneTab" class="tab-content active">
                        <ul class="scene-tree" id="sceneTree">
                            <li class="scene-tree-item">æ ¹èŠ‚ç‚¹</li>
                        </ul>
                    </div>
                    <!-- å¯¹è±¡åº“ -->
                    <div id="objectsTab" class="tab-content">
                        <div class="object-library">
                            <div class="object-card" data-object="cube">
                                <div class="object-card-icon">ğŸ“¦</div>
                                <div class="object-card-title">ç«‹æ–¹ä½“</div>
                            </div>
                            <div class="object-card" data-object="sphere">
                                <div class="object-card-icon">ğŸ”µ</div>
                                <div class="object-card-title">çƒä½“</div>
                            </div>
                            <div class="object-card" data-object="cylinder">
                                <div class="object-card-icon">ğŸ“</div>
                                <div class="object-card-title">åœ†æŸ±ä½“</div>
                            </div>
                            <div class="object-card" data-object="plane">
                                <div class="object-card-icon">ğŸ“„</div>
                                <div class="object-card-title">å¹³é¢</div>
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- ä¸­å¤®è§†å›¾åŒº -->
            <main class="viewport-area">
                <div class="view-controls">
                    <button class="control-btn active" data-tool="select">é€‰æ‹©</button>
                    <button class="control-btn" data-tool="move">ç§»åŠ¨</button>
                    <button class="control-btn" data-tool="rotate">æ—‹è½¬</button>
                    <button class="control-btn" data-tool="scale">ç¼©æ”¾</button>
                    <span style="margin-left: auto;">è§†å›¾:</span>
                    <button class="control-btn" data-view="top">é¡¶</button>
                    <button class="control-btn" data-view="front">å‰</button>
                    <button class="control-btn" data-view="right">å³</button>
                    <button class="control-btn" data-view="persp">é€è§†</button>
                </div>
                <div class="viewport">
                    <canvas id="renderCanvas"></canvas>
                </div>
            </main>

            <!-- å³ä¾§å±æ€§é¢æ¿ -->
            <aside class="right-panel">
                <div class="panel-header">å±æ€§</div>
                <div class="panel-content">
                    <div class="property-item">
                        <div class="property-label">åç§°</div>
                        <input type="text" class="property-input" value="æ ¹èŠ‚ç‚¹" readonly>
                    </div>
                    <div class="property-item">
                        <div class="property-label">ä½ç½®</div>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" class="property-input" value="0" step="0.1">
                            <input type="number" class="property-input" value="0" step="0.1">
                            <input type="number" class="property-input" value="0" step="0.1">
                        </div>
                    </div>
                    <div class="property-item">
                        <div class="property-label">æ—‹è½¬</div>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" class="property-input" value="0" step="1">
                            <input type="number" class="property-input" value="0" step="1">
                            <input type="number" class="property-input" value="0" step="1">
                        </div>
                    </div>
                    <div class="property-item">
                        <div class="property-label">ç¼©æ”¾</div>
                        <div style="display: flex; gap: 8px;">
                            <input type="number" class="property-input" value="1" step="0.1">
                            <input type="number" class="property-input" value="1" step="0.1">
                            <input type="number" class="property-input" value="1" step="0.1">
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <footer class="status-bar">
            <div class="status-item" id="fpsDisplay">FPS: 0</div>
            <div class="status-item" id="trianglesDisplay">ä¸‰è§’å½¢: 0</div>
            <div class="status-item" id="drawCallsDisplay">ç»˜åˆ¶è°ƒç”¨: 0</div>
            <div class="status-item" id="engineStatusDisplay">å¼•æ“: è¿è¡Œä¸­</div>
        </footer>
    </div>

    <script>
        // SSEç®¡ç†å™¨ï¼Œç”¨äºå¤„ç†æœåŠ¡å™¨å‘é€äº‹ä»¶
        class SSEManager {
            constructor() {
                this.eventSource = null;
                this.callbacks = {};
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectDelay = 1000;
            }

            // è¿æ¥åˆ°SSEæœåŠ¡å™¨
            connect(url) {
                try {
                    this.eventSource = new EventSource(url);
                    this.isConnected = true;
                    this.reconnectAttempts = 0;

                    // ç›‘å¬äº‹ä»¶
                    this.eventSource.onmessage = (event) => {
                        this.handleMessage(event.data);
                    };

                    this.eventSource.onopen = () => {
                        console.log('SSEè¿æ¥å·²å»ºç«‹');
                        this.isConnected = true;
                    };

                    this.eventSource.onerror = (error) => {
                        console.error('SSEè¿æ¥é”™è¯¯:', error);
                        this.isConnected = false;
                        this.attemptReconnect(url);
                    };
                } catch (error) {
                    console.error('æ— æ³•å»ºç«‹SSEè¿æ¥:', error);
                    this.attemptReconnect(url);
                }
            }

            // å°è¯•é‡è¿
            attemptReconnect(url) {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    console.log(`å°è¯•é‡è¿ SSE (${this.reconnectAttempts}/${this.maxReconnectAttempts})...`);
                    setTimeout(() => {
                        this.connect(url);
                    }, this.reconnectDelay * this.reconnectAttempts);
                } else {
                    console.error('SSEé‡è¿å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§å°è¯•æ¬¡æ•°');
                }
            }

            // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
            handleMessage(data) {
                try {
                    const message = JSON.parse(data);
                    const { type } = message;
                    
                    if (this.callbacks[type]) {
                        this.callbacks[type].forEach(callback => {
                            callback(message.data);
                        });
                    }
                } catch (error) {
                    console.error('è§£æSSEæ¶ˆæ¯å¤±è´¥:', error);
                }
            }

            // æ³¨å†Œäº‹ä»¶å›è°ƒ
            on(eventType, callback) {
                if (!this.callbacks[eventType]) {
                    this.callbacks[eventType] = [];
                }
                this.callbacks[eventType].push(callback);
            }

            // å‘é€å‘½ä»¤åˆ°æœåŠ¡å™¨
            async sendCommand(command) {
                try {
                    const response = await fetch('/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(command),
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTPé”™è¯¯! çŠ¶æ€: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('å‘é€å‘½ä»¤å¤±è´¥:', error);
                    throw error;
                }
            }

            // æ–­å¼€è¿æ¥
            disconnect() {
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                    this.isConnected = false;
                }
            }
        }

        // è§†å›¾æ§åˆ¶å™¨
        class ViewController {
            constructor(canvas, sseManager) {
                this.canvas = canvas;
                this.sseManager = sseManager;
                this.isMouseDown = false;
                this.lastMousePos = { x: 0, y: 0 };
                this.currentTool = 'select';
                
                this.setupEventListeners();
            }

            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners() {
                // é¼ æ ‡äº‹ä»¶
                this.canvas.addEventListener('mousedown', this.onMouseDown.bind(this));
                this.canvas.addEventListener('mousemove', this.onMouseMove.bind(this));
                this.canvas.addEventListener('mouseup', this.onMouseUp.bind(this));
                this.canvas.addEventListener('wheel', this.onWheel.bind(this));

                // è§¦æ‘¸äº‹ä»¶
                this.canvas.addEventListener('touchstart', this.onTouchStart.bind(this));
                this.canvas.addEventListener('touchmove', this.onTouchMove.bind(this));
                this.canvas.addEventListener('touchend', this.onTouchEnd.bind(this));

                // å·¥å…·åˆ‡æ¢
                document.querySelectorAll('.control-btn[data-tool]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchTool(e.target.dataset.tool);
                    });
                });

                // è§†å›¾åˆ‡æ¢
                document.querySelectorAll('.control-btn[data-view]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchView(e.target.dataset.view);
                    });
                });

                // å¯¹è±¡åº“
                document.querySelectorAll('.object-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        this.createObject(e.target.closest('.object-card').dataset.object);
                    });
                });

                // æ ‡ç­¾é¡µåˆ‡æ¢
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.switchTab(e.target.dataset.tab);
                    });
                });
            }

            // é¼ æ ‡æŒ‰ä¸‹
            onMouseDown(event) {
                this.isMouseDown = true;
                this.lastMousePos = { x: event.clientX, y: event.clientY };
            }

            // é¼ æ ‡ç§»åŠ¨
            onMouseMove(event) {
                if (!this.isMouseDown) return;

                const currentPos = { x: event.clientX, y: event.clientY };
                const deltaX = currentPos.x - this.lastMousePos.x;
                const deltaY = currentPos.y - this.lastMousePos.y;

                // æ ¹æ®å½“å‰å·¥å…·æ‰§è¡Œä¸åŒæ“ä½œ
                if (this.currentTool === 'select') {
                    // ç›¸æœºè½¨é“æ§åˆ¶
                    this.sseManager.sendCommand({
                        type: 'camera_orbit',
                        data: { deltaX, deltaY }
                    });
                } else if (this.currentTool === 'move') {
                    // ç‰©ä½“ç§»åŠ¨
                    this.sseManager.sendCommand({
                        type: 'object_move',
                        data: { deltaX, deltaY }
                    });
                }

                this.lastMousePos = currentPos;
            }

            // é¼ æ ‡é‡Šæ”¾
            onMouseUp() {
                this.isMouseDown = false;
            }

            // é¼ æ ‡æ»šè½®
            onWheel(event) {
                event.preventDefault();
                const delta = event.deltaY > 0 ? -0.1 : 0.1;
                
                this.sseManager.sendCommand({
                    type: 'camera_zoom',
                    data: { delta }
                });
            }

            // è§¦æ‘¸å¼€å§‹
            onTouchStart(event) {
                if (event.touches.length === 1) {
                    this.isMouseDown = true;
                    this.lastMousePos = { 
                        x: event.touches[0].clientX, 
                        y: event.touches[0].clientY 
                    };
                }
            }

            // è§¦æ‘¸ç§»åŠ¨
            onTouchMove(event) {
                if (event.touches.length === 1 && this.isMouseDown) {
                    const currentPos = { 
                        x: event.touches[0].clientX, 
                        y: event.touches[0].clientY 
                    };
                    const deltaX = currentPos.x - this.lastMousePos.x;
                    const deltaY = currentPos.y - this.lastMousePos.y;

                    this.sseManager.sendCommand({
                        type: 'camera_orbit',
                        data: { deltaX, deltaY }
                    });

                    this.lastMousePos = currentPos;
                }
            }

            // è§¦æ‘¸ç»“æŸ
            onTouchEnd() {
                this.isMouseDown = false;
            }

            // åˆ‡æ¢å·¥å…·
            switchTool(tool) {
                this.currentTool = tool;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.control-btn[data-tool]').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.control-btn[data-tool="${tool}"]`).classList.add('active');
            }

            // åˆ‡æ¢è§†å›¾
            switchView(view) {
                let commandType;
                switch(view) {
                    case 'top':
                        commandType = 'camera_set_top_view';
                        break;
                    case 'front':
                        commandType = 'camera_set_front_view';
                        break;
                    case 'right':
                        commandType = 'camera_set_right_view';
                        break;
                    case 'persp':
                        commandType = 'camera_set_perspective_view';
                        break;
                }

                this.sseManager.sendCommand({
                    type: commandType,
                    data: {}
                });

                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.control-btn[data-view]').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.control-btn[data-view="${view}"]`).classList.add('active');
            }

            // åˆ›å»ºå¯¹è±¡
            createObject(objectType) {
                let commandType;
                switch(objectType) {
                    case 'cube':
                        commandType = 'create_cube';
                        break;
                    case 'sphere':
                        commandType = 'create_sphere';
                        break;
                    case 'cylinder':
                        commandType = 'create_cylinder';
                        break;
                    case 'plane':
                        commandType = 'create_plane';
                        break;
                }

                this.sseManager.sendCommand({
                    type: commandType,
                    data: {}
                });
            }

            // åˆ‡æ¢æ ‡ç­¾é¡µ
            switchTab(tabName) {
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');

                // åˆ‡æ¢å†…å®¹
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}Tab`).classList.add('active');
            }
        }

        // æ¸²æŸ“æ§åˆ¶å™¨
        class RenderController {
            constructor(canvas) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.width = canvas.width;
                this.height = canvas.height;
                
                // é€‚åº”çª—å£å¤§å°
                this.resizeCanvas();
                window.addEventListener('resize', this.resizeCanvas.bind(this));
            }

            // è°ƒæ•´ç”»å¸ƒå¤§å°
            resizeCanvas() {
                const rect = this.canvas.parentElement.getBoundingClientRect();
                this.canvas.width = rect.width;
                this.canvas.height = rect.height;
                this.width = this.canvas.width;
                this.height = this.canvas.height;
            }

            // æ¸²æŸ“å›¾åƒ
            renderImage(imageData) {
                try {
                    const img = new Image();
                    img.onload = () => {
                        this.ctx.drawImage(img, 0, 0, this.width, this.height);
                    };
                    img.onerror = (error) => {
                        console.error('å›¾åƒåŠ è½½å¤±è´¥:', error);
                    };
                    img.src = `data:image/png;base64,${imageData}`;
                } catch (error) {
                    console.error('æ¸²æŸ“å›¾åƒå¤±è´¥:', error);
                }
            }

            // æ¸…ç©ºç”»å¸ƒ
            clear() {
                this.ctx.fillStyle = '#1a1a1a';
                this.ctx.fillRect(0, 0, this.width, this.height);
            }
        }

        // çŠ¶æ€ç®¡ç†å™¨
        class StatusManager {
            constructor() {
                this.fpsDisplay = document.getElementById('fpsDisplay');
                this.trianglesDisplay = document.getElementById('trianglesDisplay');
                this.drawCallsDisplay = document.getElementById('drawCallsDisplay');
                this.engineStatusDisplay = document.getElementById('engineStatusDisplay');
            }

            // æ›´æ–°çŠ¶æ€
            updateStatus(status) {
                if (status.fps !== undefined) {
                    this.fpsDisplay.textContent = `FPS: ${status.fps}`;
                }
                if (status.triangles !== undefined) {
                    this.trianglesDisplay.textContent = `ä¸‰è§’å½¢: ${status.triangles}`;
                }
                if (status.drawCalls !== undefined) {
                    this.drawCallsDisplay.textContent = `ç»˜åˆ¶è°ƒç”¨: ${status.drawCalls}`;
                }
                if (status.engine_status !== undefined) {
                    this.engineStatusDisplay.textContent = `å¼•æ“: ${status.engine_status}`;
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            // è·å–ç”»å¸ƒ
            const canvas = document.getElementById('renderCanvas');
            
            // åˆ›å»ºSSEç®¡ç†å™¨
            const sseManager = new SSEManager();
            
            // åˆ›å»ºæ¸²æŸ“æ§åˆ¶å™¨
            const renderController = new RenderController(canvas);
            
            // åˆ›å»ºè§†å›¾æ§åˆ¶å™¨
            const viewController = new ViewController(canvas, sseManager);
            
            // åˆ›å»ºçŠ¶æ€ç®¡ç†å™¨
            const statusManager = new StatusManager();
            
            // è¿æ¥SSE
            sseManager.connect('/events');
            
            // æ³¨å†Œäº‹ä»¶å¤„ç†
            sseManager.on('render_frame', (data) => {
                if (data.image_data) {
                    renderController.renderImage(data.image_data);
                }
            });
            
            sseManager.on('update_status', (data) => {
                statusManager.updateStatus(data);
            });
            
            sseManager.on('initial_state', (data) => {
                console.log('åˆå§‹çŠ¶æ€:', data);
            });
            
            // åˆå§‹åŒ–ç”»å¸ƒ
            renderController.clear();
            
            console.log('åº”ç”¨å·²åˆå§‹åŒ–');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
